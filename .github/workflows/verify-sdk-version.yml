name: Verify SDK Version Consistency

permissions:
  contents: read

on:
  pull_request:
  workflow_call:

jobs:
  verify-sdk-version:
    name: Check SDK Version Consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Survicate iOS SDK version from podspec
        id: podspec-version
        run: |
          VERSION=$(grep "s.dependency 'Survicate'" ios/survicate_sdk.podspec | sed -n "s/.*'Survicate',\s*'\([^']*\)'.*/\1/p" | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Podspec Survicate iOS SDK version: $VERSION"

      - name: Extract Survicate iOS SDK version from Package.swift
        id: package-version
        run: |
          VERSION=$(grep "survicate-ios-sdk.git" ios/survicate_sdk/Package.swift | sed -n 's/.*exact: "\([^"]*\)".*/\1/p' | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package.swift Survicate iOS SDK version: $VERSION"

      - name: Compare iOS SDK versions
        run: |
          PODSPEC_VERSION="${{ steps.podspec-version.outputs.version }}"
          PACKAGE_VERSION="${{ steps.package-version.outputs.version }}"

          echo "Podspec Survicate iOS SDK version: $PODSPEC_VERSION"
          echo "Package.swift Survicate iOS SDK version: $PACKAGE_VERSION"

          if [ "$PODSPEC_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "ERROR: Survicate iOS SDK versions do not match!"
            echo "  - ios/survicate_sdk.podspec: $PODSPEC_VERSION"
            echo "  - ios/survicate_sdk/Package.swift: $PACKAGE_VERSION"
            echo ""
            echo "Please update both files to use the same Survicate iOS SDK version."
            exit 1
          else
            echo "SUCCESS: Survicate iOS SDK versions match ($PODSPEC_VERSION)"
          fi

      - name: Compare tag version with pubspec.yaml
        if: github.ref_type == 'tag'
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d '[:space:]')

          echo "Tag version: $TAG_VERSION"
          echo "pubspec.yaml version: $PUBSPEC_VERSION"

          if [ "$TAG_VERSION" != "$PUBSPEC_VERSION" ]; then
            echo "ERROR: Tag version ($TAG_VERSION) does not match pubspec.yaml version ($PUBSPEC_VERSION)"
            exit 1
          else
            echo "SUCCESS: Versions match ($TAG_VERSION)"
          fi
